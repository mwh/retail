#!/bin/sh
# configure script for retail

help() {
    echo "\`configure\` configures retail to your system"
    echo
    echo "Usage: ./configure [OPTION]"
    echo
    echo Options:
    echo "  -h, --help            display help"
    echo "      --prefix=PREFIX   install files in PREFIX [~/.local]"
    exit 0
}

V_PREFIX="$HOME/.local"
S_NEXT=
for opt in "$@"
do
    if [ "$S_NEXT" ]
    then
        eval V_${S_NEXT}=\$opt
        S_NEXT=
    else
        case "$opt" in
            --prefix)
                S_NEXT=PREFIX ;;
            --prefix=*)
                V_PREFIX=`expr "$opt" : '[^=]*=\(.*\)'` ;;
            --help|-h)
                help ;;
            *)
                echo "Unknown option $opt."
        esac
    fi
done

# Check for getline support
NEED_GETLINE=
mkdir .configure-$$
cd .configure-$$
cat > test.c <<EOT
#include <stdio.h>

int main(int argc, char **argv) {
    char *buf;
    size_t size = 0;
    getline(&buf, &size, stdin);
}
EOT
cc test.c || NEED_GETLINE="-DNEED_GETLINE=1"
cd ..
rm -rf .configure-$$

echo "# Generated by configure" > Makefile.conf
echo "PREFIX = $V_PREFIX" >> Makefile.conf
echo "DEFINES = $NEED_GETLINE" >> Makefile.conf

cat Makefile.conf
